name: Frontend prebuild + image

on:
  push:
    paths:
      - 'frontend/**'
  pull_request:
    paths:
      - 'frontend/**'

jobs:
  build-frontend:
    name: Build frontend artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: frontend/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install and build
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: |
            frontend/.next
            frontend/public
            frontend/package-lock.json

  build-image:
    name: Build Docker image using prebuilt frontend
    runs-on: ubuntu-latest
    needs: build-frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download frontend build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build

      - name: Show files (debug)
        run: ls -la . && ls -la frontend || true

      - name: Build image (no push)
        run: |
          # Use the prebuilt Dockerfile which copies the built frontend directory
          docker build -f Dockerfile.prebuilt -t frontend-prebuilt:${{ github.sha }} .

      - name: Tag image for GHCR
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/realdig-frontend:${{ github.sha }}
          docker tag frontend-prebuilt:${{ github.sha }} $IMAGE
          echo "Tagged $IMAGE"

      - name: Push to GHCR (conditional)
        if: ${{ secrets.GHCR_TOKEN != '' }}
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          set -euo pipefail
          IMAGE=ghcr.io/${{ github.repository_owner }}/realdig-frontend:${{ github.sha }}
          echo "$GHCR_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push $IMAGE
          echo "Pushed $IMAGE to GHCR"
          # Pull the pushed image so we can inspect RepoDigests which include the digest
          docker pull $IMAGE
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $IMAGE || true)
          echo "image_digest=$DIGEST" >> "$GITHUB_OUTPUT"
          echo "Captured digest: $DIGEST"

      - name: Comment PR with pushed image (conditional PR)
        if: ${{ secrets.GHCR_TOKEN != '' && github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUM=${{ github.event.pull_request.number }}
          IMAGE=ghcr.io/${{ github.repository_owner }}/realdig-frontend:${{ github.sha }}
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $IMAGE || true)
          BODY="Built and pushed frontend image: $IMAGE\nDigest: $DIGEST\nWorkflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "Posting PR comment to #$PR_NUM"
          curl -sS -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/issues/$PR_NUM/comments" \
            -d "{\"body\": \"$BODY\"}"

      - name: Create GitHub Release with image (on main)
        if: ${{ secrets.GHCR_TOKEN != '' && github.ref == 'refs/heads/main' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          IMAGE=ghcr.io/${{ github.repository_owner }}/realdig-frontend:${{ github.sha }}
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' $IMAGE || true)
          SHORT=${GITHUB_SHA:0:8}
          TAG=frontend-image-$SHORT
          BODY="Frontend image published: $IMAGE\nDigest: $DIGEST\nRunner: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "Creating release $TAG"
          curl -sS -X POST -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            "${{ github.api_url }}/repos/${{ github.repository }}/releases" \
            -d "{\"tag_name\": \"$TAG\", \"name\": \"Frontend image $TAG\", \"body\": \"$BODY\", \"prerelease\": false }" || true

      - name: Save image (optional)
        if: always()
        run: docker images --format 'table {{.Repository}}:{{.Tag}}\t{{.Size}}' | sed -n '1,200p'

  smoke-test:
    name: Smoke e2e using prebuilt image (pytest)
    runs-on: ubuntu-latest
    needs: build-image
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download frontend build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build

      - name: Build prebuilt image for smoke test
        run: |
          docker build -f Dockerfile.prebuilt -t realdiag-frontend:smoketest .

      - name: Create docker-compose local override
        run: |
          cat > docker-compose.local.yml <<'YML'
          version: "3.9"
          services:
            web:
              image: realdiag-frontend:smoketest
              build: null
          YML

      - name: Run e2e pytest
        env:
          # ensure python tests can find docker in PATH
          PATH: /usr/local/bin:/usr/bin:/bin:$PATH
        run: |
          docker compose -f docker-compose.yml -f docker-compose.local.yml up -d --remove-orphans
          # run the same pytest e2e test the project uses
          pytest -q tests/test_e2e.py::test_e2e_stack

      - name: Tear down stack
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.local.yml down
